{% extends "base.html" %}

{% block content %}

    
    <div class="chat-container">
        <div class="messages" id="messagesContainer">
            {% for message in history %}
            <div class="message {{ message.sender }}-message">
                {% if message.sender == 'bot' %}
                <div class="message-header">
                    <i class="fas fa-robot bot-icon"></i>
                    <span>AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                </div>
                {% endif %}
                <div class="message-content">{{ message.text }}</div>
                <div class="message-time">
                    {{ message.timestamp|datetimeformat }}
                </div>
            </div>
            {% endfor %}
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="input-area">
            <div class="emoji-picker-container">
                <button class="emoji-btn" id="emojiBtn">üòä</button>
                <div class="emoji-picker" id="emojiPicker"></div>
            </div>
            <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button id="sendButton">
                <i class="fas fa-paper-plane"></i>
                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emoji-mart/data"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emoji-mart/js"></script>
    <script>
document.addEventListener('DOMContentLoaded', async () => {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const messagesContainer = document.getElementById('messagesContainer');
    const errorMessage = document.getElementById('errorMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è emoji picker
    async function initEmojiPicker() {
        const response = await fetch('https://cdn.jsdelivr.net/npm/@emoji-mart/data')
        const data = await response.json()
        
        new EmojiMart.Picker({
            data: data,
            onEmojiSelect: (emoji) => {
                messageInput.value += emoji.native;
                messageInput.focus();
            },
            dynamicWidth: true,
            previewPosition: 'none',
            skinTonePosition: 'none',
            theme: 'light'
        }).then(picker => {
            emojiPicker.appendChild(picker);
        });
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å emoji picker
    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
    });
    
    // –°–∫—Ä—ã—Ç—å emoji picker –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', () => {
        emojiPicker.style.display = 'none';
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è emoji picker
    initEmojiPicker();
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    function addMessage(sender, text, timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        if (sender === 'bot') {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const icon = document.createElement('i');
            icon.className = 'fas fa-robot bot-icon';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = 'AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç';
            
            headerDiv.appendChild(icon);
            headerDiv.appendChild(nameSpan);
            messageDiv.appendChild(headerDiv);
        }
        
        const textDiv = document.createElement('div');
        textDiv.className = 'message-content';
        textDiv.innerHTML = text.replace(/\n/g, '<br>');
        messageDiv.appendChild(textDiv);
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        messageDiv.appendChild(timeDiv);
        
        messagesContainer.insertBefore(messageDiv, typingIndicator);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showTypingIndicator() {
        typingIndicator.style.display = 'flex';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        
        try {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É (optimistic update)
            addMessage('user', text);
            messageInput.value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            showTypingIndicator();
            
            const response = await fetch('/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: {{ user.id }},
                    text: text
                }),
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
            
            const data = await response.json();
            hideTypingIndicator();
            addMessage('bot', data.answer);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞:', err);
            hideTypingIndicator();
            errorMessage.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è';
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        } finally {
            sendButton.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    
    
    // –§–æ–∫—É—Å–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    messageInput.focus();
});
    </script>

{% endblock %}
{% block footer %}{% endblock %}